<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drivy Taxi Calculator</title>
    <link rel="icon" type="image/png" href="drivy.png">
    <link rel="shortcut icon" type="image/png" href="drivy.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', 'Roboto', sans-serif;
        }

        body {
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .header {
            background: #666666;
            padding: 15px 20px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            overflow: hidden;
            background: #888;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
        }

        .reset-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 8px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reset-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .reset-btn svg {
            width: 16px;
            height: 16px;
        }

        .language-toggle {
            cursor: pointer;
            transition: transform 0.2s;
            width: 30px;
            height: 20px;
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.3);
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .language-toggle:hover {
            transform: scale(1.1);
        }

        .content {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #333;
            font-size: 13px;
        }

        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #888;
        }

        #map {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .location-inputs {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .location-input {
            position: relative;
            margin-bottom: 10px;
        }

        .location-input input {
            padding-left: 30px;
            padding-right: 45px;
        }

        .location-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            z-index: 2;
        }

        .departure-icon { color: #4CAF50; }
        .stop-icon { color: #FF9800; }
        .destination-icon { color: #f44336; }

        .map-pin-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #4285F4;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .map-pin-btn:hover {
            background: #3367D6;
            transform: translateY(-50%) scale(1.1);
        }

        .map-pin-btn.active {
            background: #FF9800;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }

        .add-stop-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 5px;
            width: 100%;
            justify-content: center;
        }

        .add-stop-btn:hover {
            background: #128C7E;
        }

        .stop-container {
            position: relative;
            padding-right: 30px;
            margin-bottom: 15px;
        }

        .stop-row {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .stop-input-wrapper {
            flex: 1;
        }

        .stop-time-wrapper {
            width: 120px;
        }

        .stop-time-wrapper label {
            font-size: 11px;
            margin-bottom: 4px;
        }

        .stop-time-wrapper input {
            text-align: center;
            font-size: 12px;
            padding: 6px 4px;
        }

        .remove-stop-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #f44336;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .distance-display {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 15px;
            border: 1px solid #90caf9;
            display: none;
        }

        .distance-display .label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .distance-display .value {
            font-size: 20px;
            font-weight: bold;
            color: #1976d2;
        }

        .rate-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px;
            background: #f8f8f8;
            border-radius: 4px;
            margin-top: 6px;
            font-size: 12px;
            color: #555;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        .checkbox-item label {
            margin-bottom: 0;
            font-weight: normal;
            font-size: 12px;
            color: #555;
        }

        .baggage-container {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
            margin-bottom: 15px;
        }

        .baggage-row {
            display: flex;
            gap: 10px;
            align-items: end;
            margin-bottom: 15px;
        }

        .baggage-item {
            flex: 1;
        }

        .baggage-item label {
            font-size: 11px;
            margin-bottom: 4px;
            text-align: center;
            display: block;
        }

        .baggage-item input {
            text-align: center;
            font-size: 12px;
            padding: 6px 4px;
        }

        .van-option {
            margin-bottom: 15px;
            display: none;
        }

        .van-option.show {
            display: block;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            color: #444;
            margin-bottom: 8px;
            margin-top: 10px;
        }

        .sub-title {
            font-size: 12px;
            color: #777;
            margin-bottom: 6px;
        }

        .bulky-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            margin-top: 8px;
            display: none;
        }

        .bulky-warning.show {
            display: block;
        }

        .fare-display {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .fare-display .disclaimer {
            font-size: 11px;
            color: #777;
            font-style: italic;
            margin-bottom: 10px;
        }

        .fare-display .price {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .vehicle-note {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .route-prompt {
            font-size: 16px;
            color: #666;
            padding: 20px;
            font-style: italic;
        }

        .request-ride-btn {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            transition: all 0.3s ease;
        }

        .request-ride-btn:hover {
            background: linear-gradient(135deg, #128C7E 0%, #075E54 100%);
            transform: translateY(-2px);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            margin: 20px;
            padding: 24px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            background: #f0f0f0;
        }

        .modal-form-group {
            margin-bottom: 16px;
        }

        .modal-label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .modal-input, .modal-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .modal-input:focus, .modal-select:focus {
            outline: none;
            border-color: #25D366;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-btn-cancel {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e0e0e0;
        }

        .modal-btn-cancel:hover {
            background: #e9ecef;
        }

        .modal-btn-confirm {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
        }

        .modal-btn-confirm:hover {
            background: linear-gradient(135deg, #128C7E 0%, #075E54 100%);
        }

        .name-row {
            display: flex;
            gap: 12px;
        }

        .name-row .modal-form-group {
            flex: 1;
        }

        .map-click-instruction {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            font-size: 14px;
            display: none;
        }

        .map-click-instruction.show {
            display: block;
        }

        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="logo">
                    DT
                </div>
                <h1 class="title" id="headerTitle">Calcule ton trajet</h1>
            </div>
            <div class="header-right">
                <button class="reset-btn" onclick="resetForm()">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C9.25022 4 6.82447 5.38734 5.38451 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M9 7.5L5.38451 7.5L5.38451 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div class="language-toggle" onclick="toggleLanguage()" id="languageToggle">
                    🇬🇧
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Google Map -->
            <div style="position: relative;">
                <div id="map">
                    <div class="loading-spinner"></div>
                </div>
                <div class="map-click-instruction" id="mapInstruction">
                    <span id="mapInstructionText">Cliquez sur la carte pour sélectionner</span>
                </div>
            </div>

            <!-- Location Inputs -->
            <div class="location-inputs">
                <div class="location-input">
                    <span class="location-icon departure-icon">●</span>
                    <input type="text" id="departure" placeholder="Point de départ" autocomplete="off">
                    <button class="map-pin-btn" onclick="selectOnMap('departure')" title="Sélectionner sur la carte">📍</button>
                </div>
                
                <div id="stopsContainer"></div>
                
                <button class="add-stop-btn" onclick="addStop()">
                    <span>+</span>
                    <span id="addStopText">Ajouter un arrêt</span>
                </button>
                
                <div class="location-input">
                    <span class="location-icon destination-icon">●</span>
                    <input type="text" id="destination" placeholder="Destination" autocomplete="off">
                    <button class="map-pin-btn" onclick="selectOnMap('destination')" title="Sélectionner sur la carte">📍</button>
                </div>
            </div>

            <!-- Distance Display -->
            <div class="distance-display" id="distanceDisplay">
                <div class="label" id="distanceLabel">Distance totale</div>
                <div class="value" id="totalDistance">0 km</div>
            </div>

            <div class="form-group">
                <label id="pickupTimeLabel">Heure de prise en charge</label>
                <input type="time" id="pickupTime" onchange="updateRateIndicator(); calculateFare()">
                <div class="rate-indicator">
                    <span id="rateIcon">☀️</span>
                    <span id="rateText">Tarif jour</span>
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="departureUpHigh" onchange="calculateFare()">
                    <label for="departureUpHigh" id="departureUpHighLabel">Point de départ en hauteur</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="destinationUpHigh" onchange="calculateFare()">
                    <label for="destinationUpHigh" id="destinationUpHighLabel">Destination en hauteur</label>
                </div>
            </div>

            <div class="form-group">
                <label id="passengersLabel">👤 Nombre de passagers</label>
                <input type="number" id="passengers" min="1" value="1" oninput="calculateFare(); toggleVanBooking()">
            </div>

            <div class="van-option" id="vanOption">
                <div class="checkbox-item">
                    <input type="checkbox" id="vanBooking" onchange="calculateFare()">
                    <label for="vanBooking" id="vanBookingLabel">🚐 Réserver un Van</label>
                </div>
            </div>

            <div class="baggage-container">
                <div class="baggage-row">
                    <div class="baggage-item">
                        <label id="baggageCheckedLabel">Bagages soute</label>
                        <input type="number" id="baggageChecked" min="0" value="0" oninput="calculateFare(); checkVehicleLimit()">
                    </div>
                    <div class="baggage-item">
                        <label id="baggageCabinLabel">Bagages cabine</label>
                        <input type="number" id="baggageCabin" min="0" value="0" oninput="calculateFare(); checkVehicleLimit()">
                    </div>
                    <div class="baggage-item">
                        <label id="baggageBagsLabel">Sacs 5kg</label>
                        <input type="number" id="baggageBags" min="0" value="0" oninput="calculateFare()">
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <div class="section-title" id="bulkyItemsTitle">Encombrants</div>
                    <div class="sub-title" id="bulkyItemsSubtitle">(bagages hors taille standard, glacière, cantine, planche de surf, vélo, sac de golf, poussette, fauteuil roulant, etc.)</div>
                    <select id="bulkyItems" onchange="calculateFare(); checkVehicleLimit()">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="plus">+</option>
                    </select>
                </div>
            </div>

            <div class="bulky-warning" id="vehicleWarning">
                <span id="vehicleWarningText">⚠️ Vous aurez probablement besoin d'un véhicule supplémentaire</span>
            </div>

            <div class="fare-display">
                <div id="fareContent">
                    <div class="route-prompt" id="routePrompt">Veuillez entrer l'itinéraire pour avoir le tarif</div>
                </div>
            </div>

            <button class="request-ride-btn" onclick="openRequestModal()">
                <span id="requestRideText">Demander une course</span>
            </button>
        </div>
    </div>

    <!-- Modal de demande de course -->
    <div class="modal" id="requestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Complément d'informations</h2>
                <button class="close-btn" onclick="closeRequestModal()">&times;</button>
            </div>

            <form id="requestForm">
                <div class="modal-form-group">
                    <label class="modal-label" id="tripDateLabel">Date de la course</label>
                    <input type="date" class="modal-input" id="tripDate" required>
                </div>

                <div class="name-row">
                    <div class="modal-form-group">
                        <label class="modal-label" id="firstNameLabel">Prénom</label>
                        <input type="text" class="modal-input" id="firstName" required>
                    </div>
                    <div class="modal-form-group">
                        <label class="modal-label" id="lastNameLabel">Nom</label>
                        <input type="text" class="modal-input" id="lastName" required>
                    </div>
                </div>

                <div class="modal-form-group">
                    <label class="modal-label" id="flightFerryLabel">Numéro de vol ou ferry (optionnel)</label>
                    <input type="text" class="modal-input" id="flightFerry" placeholder="Ex: AF073 ou Ferry Terevau">
                </div>

                <div class="modal-form-group">
                    <label class="modal-label" id="paymentMethodLabel">Moyen de paiement</label>
                    <select class="modal-select" id="paymentMethod" required>
                        <option value="">-- Choisir --</option>
                        <option value="cash_xpf">Cash en XPF</option>
                        <option value="cash_usd">Cash en USD</option>
                        <option value="card_eur">Visa/MasterCard en EUR</option>
                        <option value="card_usd">Visa/MasterCard en USD</option>
                    </select>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="modal-btn modal-btn-cancel" onclick="closeRequestModal()" id="cancelBtn">Annuler</button>
                    <button type="submit" class="modal-btn modal-btn-confirm" id="sendBtn">Envoyer la demande sur WhatsApp</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let currentLang = 'fr';
        let map;
        let directionsService;
        let directionsRenderer;
        let geocoder;
        let totalDistanceKm = 0;
        let selectingForInput = null;
        let stops = [];
        let markers = [];
        let currentLocationMarker = null;
        let placeAutocomplete = {};
        let sessionToken;

        const translations = {
            fr: {
                headerTitle: "Calcule ton trajet",
                departurePoint: "Point de départ",
                destination: "Destination",
                addStopText: "Ajouter un arrêt",
                distanceLabel: "Distance totale",
                pickupTimeLabel: "Heure de prise en charge",
                departureUpHighLabel: "Point de départ en hauteur",
                destinationUpHighLabel: "Destination en hauteur",
                passengersLabel: "👤 Nombre de passagers",
                vanBookingLabel: "🚐 Réserver un Van",
                baggageCheckedLabel: "Bagages soute",
                baggageCabinLabel: "Bagages cabine",
                baggageBagsLabel: "Sacs 5kg",
                bulkyItemsTitle: "Encombrants",
                bulkyItemsSubtitle: "(bagages hors taille standard, glacière, cantine, planche de surf, vélo, sac de golf, poussette, fauteuil roulant, etc.)",
                vehicleWarningText: "⚠️ Vous aurez probablement besoin d'un véhicule supplémentaire",
                routePrompt: "Veuillez entrer l'itinéraire pour avoir le tarif",
                requestRideText: "Demander une course",
                modalTitle: "Complément d'informations",
                tripDateLabel: "Date de la course",
                firstNameLabel: "Prénom",
                lastNameLabel: "Nom",
                flightFerryLabel: "Numéro de vol ou ferry (optionnel)",
                paymentMethodLabel: "Moyen de paiement",
                cancelBtn: "Annuler",
                sendBtn: "Envoyer la demande sur WhatsApp",
                rateTextDay: "Tarif jour",
                rateTextNight: "Tarif nuit",
                disclaimer: "C'est une bonne estimation du prix final mais le chauffeur utilisera le taximètre pour avoir le tarif exacte",
                vehicleNote: "Pour 1 véhicule",
                stopLabel: "Arrêt",
                stopTimeLabel: "Durée d'arrêt (min)",
                mapInstructionText: "Cliquez sur la carte pour sélectionner"
            },
            en: {
                headerTitle: "Calculate your trip",
                departurePoint: "Departure point",
                destination: "Destination",
                addStopText: "Add a stop",
                distanceLabel: "Total distance",
                pickupTimeLabel: "Pickup time",
                departureUpHighLabel: "Departure point up high",
                destinationUpHighLabel: "Destination up high",
                passengersLabel: "👤 Number of passengers",
                vanBookingLabel: "🚐 Book a Van",
                baggageCheckedLabel: "Checked bags",
                baggageCabinLabel: "Cabin bags",
                baggageBagsLabel: "Bags 5kg",
                bulkyItemsTitle: "Bulky items",
                bulkyItemsSubtitle: "(oversized luggage, cooler, canteen, surfboard, bike, golf bag, stroller, wheelchair, etc.)",
                vehicleWarningText: "⚠️ You will probably need an additional vehicle",
                routePrompt: "Please enter the route to get the fare",
                requestRideText: "Request a Ride",
                modalTitle: "Additional Information",
                tripDateLabel: "Trip Date",
                firstNameLabel: "First Name",
                lastNameLabel: "Last Name",
                flightFerryLabel: "Flight or Ferry Number (optional)",
                paymentMethodLabel: "Payment Method",
                cancelBtn: "Cancel",
                sendBtn: "Send Request on WhatsApp",
                rateTextDay: "Day rate",
                rateTextNight: "Night rate",
                disclaimer: "This is a good estimate of the final price but the driver will use the taximeter for the exact fare",
                vehicleNote: "For 1 vehicle",
                stopLabel: "Stop",
                stopTimeLabel: "Stop duration (min)",
                mapInstructionText: "Click on the map to select"
            }
        };

        // Initialiser Google Maps avec le nouveau système de chargement
        async function initMap() {
            // Importer les bibliothèques nécessaires
            const { Map } = await google.maps.importLibrary("maps");
            const { DirectionsService, DirectionsRenderer } = await google.maps.importLibrary("routes");
            const { PlaceAutocompleteElement, Place } = await google.maps.importLibrary("places");
            const { Geocoder } = await google.maps.importLibrary("geocoding");
            const { Marker } = await google.maps.importLibrary("marker");

            // Centre sur Tahiti
            const tahitiCenter = { lat: -17.5516, lng: -149.5585 };
            
            // Créer la carte
            map = new Map(document.getElementById('map'), {
                zoom: 11,
                center: tahitiCenter,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                clickableIcons: false
            });

            // Initialiser les services
            directionsService = new DirectionsService();
            directionsRenderer = new DirectionsRenderer({
                map: map,
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#4285F4',
                    strokeWeight: 4
                }
            });

            geocoder = new Geocoder();

            // Créer un nouveau token de session
            sessionToken = new google.maps.places.AutocompleteSessionToken();

            // Configuration des champs de saisie
            setupPlaceAutocomplete('departure');
            setupPlaceAutocomplete('destination');

            // Listener pour clic sur la carte
            map.addListener('click', (event) => {
                if (selectingForInput) {
                    handleMapClick(event.latLng);
                }
            });

            // Géolocalisation
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Vérifier si la position est à Tahiti
                        const bounds = new google.maps.LatLngBounds(
                            new google.maps.LatLng(-17.9, -150.0),
                            new google.maps.LatLng(-17.2, -149.1)
                        );
                        
                        if (bounds.contains(userLocation)) {
                            map.setCenter(userLocation);
                            map.setZoom(13);
                            
                            // Ajouter un marqueur pour la position actuelle
                            currentLocationMarker = new google.maps.Marker({
                                position: userLocation,
                                map: map,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: '#4285F4',
                                    fillOpacity: 1,
                                    strokeColor: '#ffffff',
                                    strokeWeight: 2
                                },
                                title: 'Votre position'
                            });
                        }
                    }
                );
            }

            // Masquer le spinner de chargement
            document.querySelector('.loading-spinner').style.display = 'none';
        }

        // Configuration de l'autocomplétion pour un champ
        async function setupPlaceAutocomplete(inputId) {
            const input = document.getElementById(inputId);
            
            // Créer le widget d'autocomplétion
            const placeAutocompleteElement = new google.maps.places.PlaceAutocompleteElement({
                componentRestrictions: { country: 'pf' },
                fields: ['formatted_address', 'geometry', 'name'],
                locationBias: new google.maps.LatLngBounds(
                    new google.maps.LatLng(-17.9, -150.0),
                    new google.maps.LatLng(-17.2, -149.1)
                )
            });
            
            // Remplacer l'input par l'élément d'autocomplétion
            input.style.display = 'none';
            input.parentNode.insertBefore(placeAutocompleteElement, input.nextSibling);
            
            // Écouter les changements de place
            placeAutocompleteElement.addEventListener('gmp-placeselect', async (event) => {
                const place = event.place;
                if (place && place.location) {
                    input.value = place.displayName || place.formattedAddress;
                    calculateRoute();
                }
            });
            
            placeAutocomplete[inputId] = placeAutocompleteElement;
        }

        // Configuration pour les arrêts
        async function setupStopAutocomplete(stopIndex) {
            const inputId = `stop-${stopIndex}`;
            const input = document.getElementById(inputId);
            
            // Créer le widget d'autocomplétion
            const placeAutocompleteElement = new google.maps.places.PlaceAutocompleteElement({
                componentRestrictions: { country: 'pf' },
                fields: ['formatted_address', 'geometry', 'name'],
                locationBias: new google.maps.LatLngBounds(
                    new google.maps.LatLng(-17.9, -150.0),
                    new google.maps.LatLng(-17.2, -149.1)
                )
            });
            
            // Remplacer l'input par l'élément d'autocomplétion
            input.style.display = 'none';
            input.parentNode.insertBefore(placeAutocompleteElement, input.nextSibling);
            
            // Écouter les changements de place
            placeAutocompleteElement.addEventListener('gmp-placeselect', async (event) => {
                const place = event.place;
                if (place && place.location) {
                    input.value = place.displayName || place.formattedAddress;
                    stops[stopIndex].address = input.value;
                    calculateRoute();
                }
            });
            
            placeAutocomplete[inputId] = placeAutocompleteElement;
        }

        // Sélection sur la carte
        function selectOnMap(inputId) {
            selectingForInput = inputId;
            
            // Mettre à jour l'apparence des boutons
            document.querySelectorAll('.map-pin-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activer le bouton cliqué
            const btn = document.querySelector(`#${inputId}`).parentNode.querySelector('.map-pin-btn');
            if (btn) btn.classList.add('active');
            
            // Afficher l'instruction
            document.getElementById('mapInstruction').classList.add('show');
            
            // Changer le curseur de la carte
            map.setOptions({ draggableCursor: 'crosshair' });
        }

        // Gérer le clic sur la carte
        async function handleMapClick(latLng) {
            if (!selectingForInput) return;

            try {
                const response = await geocoder.geocode({ location: latLng });
                
                if (response.results && response.results[0]) {
                    const input = document.getElementById(selectingForInput);
                    input.value = response.results[0].formatted_address;
                    
                    // Mettre à jour l'objet stops si c'est un arrêt
                    if (selectingForInput.startsWith('stop-')) {
                        const stopIndex = parseInt(selectingForInput.split('-')[1]);
                        if (stops[stopIndex]) {
                            stops[stopIndex].address = response.results[0].formatted_address;
                        }
                    }
                    
                    // Créer un marqueur temporaire
                    const marker = new google.maps.Marker({
                        position: latLng,
                        map: map,
                        animation: google.maps.Animation.DROP
                    });
                    
                    markers.push(marker);
                    
                    calculateRoute();
                    resetMapSelection();
                }
            } catch (error) {
                console.error('Erreur de géocodage:', error);
            }
        }

        // Réinitialiser la sélection sur carte
        function resetMapSelection() {
            selectingForInput = null;
            document.querySelectorAll('.map-pin-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('mapInstruction').classList.remove('show');
            map.setOptions({ draggableCursor: null });
        }

        // Ajouter un arrêt
        function addStop() {
            const stopIndex = stops.length;
            stops.push({ address: '', duration: 0 });
            
            const container = document.getElementById('stopsContainer');
            const stopDiv = document.createElement('div');
            stopDiv.className = 'stop-container';
            stopDiv.id = `stop-container-${stopIndex}`;
            
            stopDiv.innerHTML = `
                <div class="stop-row">
                    <div class="stop-input-wrapper">
                        <div class="location-input">
                            <span class="location-icon stop-icon">●</span>
                            <input type="text" id="stop-${stopIndex}" placeholder="${translations[currentLang].stopLabel} ${stopIndex + 1}" autocomplete="off">
                            <button class="map-pin-btn" onclick="selectOnMap('stop-${stopIndex}')" title="Sélectionner sur la carte">📍</button>
                        </div>
                    </div>
                    <div class="stop-time-wrapper">
                        <label>${translations[currentLang].stopTimeLabel}</label>
                        <input type="number" id="stop-duration-${stopIndex}" min="0" value="0" onchange="updateStopDuration(${stopIndex})">
                    </div>
                </div>
                <button class="remove-stop-btn" onclick="removeStop(${stopIndex})">×</button>
            `;
            
            container.appendChild(stopDiv);
            setupStopAutocomplete(stopIndex);
        }

        // Supprimer un arrêt
        function removeStop(index) {
            stops.splice(index, 1);
            
            // Supprimer l'élément d'autocomplétion
            delete placeAutocomplete[`stop-${index}`];
            
            // Reconstruire tous les arrêts
            const container = document.getElementById('stopsContainer');
            container.innerHTML = '';
            
            const oldStops = [...stops];
            stops = [];
            
            oldStops.forEach((stop, i) => {
                addStop();
                document.getElementById(`stop-${i}`).value = stop.address;
                document.getElementById(`stop-duration-${i}`).value = stop.duration;
            });
            
            calculateRoute();
        }

        // Mettre à jour la durée d'un arrêt
        function updateStopDuration(index) {
            const duration = parseInt(document.getElementById(`stop-duration-${index}`).value) || 0;
            if (stops[index]) {
                stops[index].duration = duration;
            }
            calculateFare();
        }

        // Calculer l'itinéraire
        async function calculateRoute() {
            const departure = document.getElementById('departure').value;
            const destination = document.getElementById('destination').value;
            
            if (!departure || !destination || !directionsService) return;
            
            // Effacer les marqueurs précédents
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // Construire les waypoints
            const waypoints = stops
                .filter(stop => stop.address)
                .map(stop => ({
                    location: stop.address,
                    stopover: true
                }));
            
            const request = {
                origin: departure,
                destination: destination,
                waypoints: waypoints,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                region: 'pf'
            };
            
            try {
                const result = await directionsService.route(request);
                directionsRenderer.setDirections(result);
                
                // Calculer la distance totale
                let totalDistance = 0;
                result.routes[0].legs.forEach(leg => {
                    totalDistance += leg.distance.value;
                });
                
                totalDistanceKm = totalDistance / 1000;
                document.getElementById('totalDistance').textContent = totalDistanceKm.toFixed(1) + ' km';
                document.getElementById('distanceDisplay').style.display = 'block';
                
                // Ajouter des marqueurs personnalisés
                const route = result.routes[0];
                
                // Marqueur de départ
                new google.maps.Marker({
                    position: route.legs[0].start_location,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#4CAF50',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    },
                    title: 'Départ'
                });
                
                // Marqueurs des arrêts
                for (let i = 0; i < waypoints.length; i++) {
                    new google.maps.Marker({
                        position: route.legs[i].end_location,
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: '#FF9800',
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 2
                        },
                        title: `Arrêt ${i + 1}`
                    });
                }
                
                // Marqueur de destination
                new google.maps.Marker({
                    position: route.legs[route.legs.length - 1].end_location,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#f44336',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    },
                    title: 'Destination'
                });
                
                calculateFare();
                
            } catch (error) {
                console.error('Erreur de calcul d\'itinéraire:', error);
            }
        }

        // Calculer le tarif
        function calculateFare() {
            if (totalDistanceKm === 0) return;
            
            const pickupTime = document.getElementById('pickupTime').value;
            const isNightRate = isNightTime(pickupTime);
            const departureUpHigh = document.getElementById('departureUpHigh').checked;
            const destinationUpHigh = document.getElementById('destinationUpHigh').checked;
            const passengers = parseInt(document.getElementById('passengers').value) || 1;
            const baggageChecked = parseInt(document.getElementById('baggageChecked').value) || 0;
            const baggageCabin = parseInt(document.getElementById('baggageCabin').value) || 0;
            const baggageBags = parseInt(document.getElementById('baggageBags').value) || 0;
            const bulkyItems = document.getElementById('bulkyItems').value;
            const vanBooking = document.getElementById('vanBooking').checked;
            
            // Tarifs de base
            const baseRate = isNightRate ? 2100 : 1500;
            const perKmRate = isNightRate ? 180 : 150;
            
            // Calcul du tarif de base
            let fare = baseRate + (totalDistanceKm * perKmRate);
            
            // Frais supplémentaires
            if (departureUpHigh) fare += 1000;
            if (destinationUpHigh) fare += 1000;
            
            // Frais pour arrêts
            const totalStopTime = stops.reduce((total, stop) => total + stop.duration, 0);
            fare += totalStopTime * 40; // 40 XPF par minute d'arrêt
            
            // Frais bagages
            fare += baggageChecked * 300;
            fare += baggageCabin * 200;
            fare += baggageBags * 100;
            
            // Frais encombrants
            if (bulkyItems === '1') fare += 500;
            else if (bulkyItems === 'plus') fare += 1000;
            
            // Frais van
            if (vanBooking) fare += 2000;
            
            // Afficher le tarif
            displayFare(fare);
        }

        // Vérifier si c'est le tarif de nuit
        function isNightTime(time) {
            if (!time) return false;
            const [hours] = time.split(':').map(Number);
            return hours >= 20 || hours < 6;
        }

        // Afficher le tarif
        function displayFare(fare) {
            const fareContent = document.getElementById('fareContent');
            fareContent.innerHTML = `
                <div class="disclaimer">${translations[currentLang].disclaimer}</div>
                <div class="price">${fare.toLocaleString('fr-FR')} XPF</div>
                <div class="vehicle-note">${translations[currentLang].vehicleNote}</div>
            `;
        }

        // Mettre à jour l'indicateur de tarif
        function updateRateIndicator() {
            const pickupTime = document.getElementById('pickupTime').value;
            const isNight = isNightTime(pickupTime);
            
            document.getElementById('rateIcon').textContent = isNight ? '🌙' : '☀️';
            document.getElementById('rateText').textContent = isNight ? 
                translations[currentLang].rateTextNight : 
                translations[currentLang].rateTextDay;
        }

        // Basculer l'affichage de l'option van
        function toggleVanBooking() {
            const passengers = parseInt(document.getElementById('passengers').value) || 1;
            const vanOption = document.getElementById('vanOption');
            
            if (passengers > 4) {
                vanOption.classList.add('show');
            } else {
                vanOption.classList.remove('show');
                document.getElementById('vanBooking').checked = false;
            }
        }

        // Vérifier la limite du véhicule
        function checkVehicleLimit() {
            const baggageChecked = parseInt(document.getElementById('baggageChecked').value) || 0;
            const baggageCabin = parseInt(document.getElementById('baggageCabin').value) || 0;
            const bulkyItems = document.getElementById('bulkyItems').value;
            const warning = document.getElementById('vehicleWarning');
            
            const totalLargeBaggage = baggageChecked + baggageCabin + (bulkyItems === 'plus' ? 2 : bulkyItems === '1' ? 1 : 0);
            
            if (totalLargeBaggage > 4) {
                warning.classList.add('show');
            } else {
                warning.classList.remove('show');
            }
        }

        // Basculer la langue
        function toggleLanguage() {
            currentLang = currentLang === 'fr' ? 'en' : 'fr';
            updateLanguage();
        }

        // Mettre à jour les textes selon la langue
        function updateLanguage() {
            const t = translations[currentLang];
            
            // Mettre à jour tous les textes
            document.getElementById('headerTitle').textContent = t.headerTitle;
            document.getElementById('departure').placeholder = t.departurePoint;
            document.getElementById('destination').placeholder = t.destination;
            document.getElementById('addStopText').textContent = t.addStopText;
            document.getElementById('distanceLabel').textContent = t.distanceLabel;
            document.getElementById('pickupTimeLabel').textContent = t.pickupTimeLabel;
            document.getElementById('departureUpHighLabel').textContent = t.departureUpHighLabel;
            document.getElementById('destinationUpHighLabel').textContent = t.destinationUpHighLabel;
            document.getElementById('passengersLabel').textContent = t.passengersLabel;
            document.getElementById('vanBookingLabel').textContent = t.vanBookingLabel;
            document.getElementById('baggageCheckedLabel').textContent = t.baggageCheckedLabel;
            document.getElementById('baggageCabinLabel').textContent = t.baggageCabinLabel;
            document.getElementById('baggageBagsLabel').textContent = t.baggageBagsLabel;
            document.getElementById('bulkyItemsTitle').textContent = t.bulkyItemsTitle;
            document.getElementById('bulkyItemsSubtitle').textContent = t.bulkyItemsSubtitle;
            document.getElementById('vehicleWarningText').textContent = t.vehicleWarningText;
            document.getElementById('routePrompt').textContent = t.routePrompt;
            document.getElementById('requestRideText').textContent = t.requestRideText;
            document.getElementById('modalTitle').textContent = t.modalTitle;
            document.getElementById('tripDateLabel').textContent = t.tripDateLabel;
            document.getElementById('firstNameLabel').textContent = t.firstNameLabel;
            document.getElementById('lastNameLabel').textContent = t.lastNameLabel;
            document.getElementById('flightFerryLabel').textContent = t.flightFerryLabel;
            document.getElementById('paymentMethodLabel').textContent = t.paymentMethodLabel;
            document.getElementById('cancelBtn').textContent = t.cancelBtn;
            document.getElementById('sendBtn').textContent = t.sendBtn;
            document.getElementById('mapInstructionText').textContent = t.mapInstructionText;
            
            updateRateIndicator();
            
            // Mettre à jour le drapeau
            document.getElementById('languageToggle').textContent = currentLang === 'fr' ? '🇬🇧' : '🇫🇷';
            
            // Mettre à jour les arrêts existants
            stops.forEach((stop, i) => {
                const input = document.getElementById(`stop-${i}`);
                if (input) {
                    input.placeholder = `${t.stopLabel} ${i + 1}`;
                }
                const label = document.querySelector(`#stop-container-${i} .stop-time-wrapper label`);
                if (label) {
                    label.textContent = t.stopTimeLabel;
                }
            });
            
            calculateFare();
        }

        // Réinitialiser le formulaire
        function resetForm() {
            // Réinitialiser tous les champs
            document.getElementById('departure').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('pickupTime').value = '';
            document.getElementById('departureUpHigh').checked = false;
            document.getElementById('destinationUpHigh').checked = false;
            document.getElementById('passengers').value = '1';
            document.getElementById('vanBooking').checked = false;
            document.getElementById('baggageChecked').value = '0';
            document.getElementById('baggageCabin').value = '0';
            document.getElementById('baggageBags').value = '0';
            document.getElementById('bulkyItems').value = '0';
            
            // Supprimer tous les arrêts
            stops = [];
            document.getElementById('stopsContainer').innerHTML = '';
            
            // Réinitialiser l'affichage
            document.getElementById('distanceDisplay').style.display = 'none';
            document.getElementById('fareContent').innerHTML = `<div class="route-prompt" id="routePrompt">${translations[currentLang].routePrompt}</div>`;
            document.getElementById('vehicleWarning').classList.remove('show');
            document.getElementById('vanOption').classList.remove('show');
            
            // Réinitialiser la carte
            if (directionsRenderer) {
                directionsRenderer.setDirections({ routes: [] });
            }
            
            // Effacer les marqueurs
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            totalDistanceKm = 0;
            updateRateIndicator();
            resetMapSelection();
            
            // Créer un nouveau token de session
            sessionToken = new google.maps.places.AutocompleteSessionToken();
        }

        // Ouvrir le modal de demande
        function openRequestModal() {
            if (totalDistanceKm === 0) {
                alert(currentLang === 'fr' ? 
                    'Veuillez d\'abord entrer un itinéraire' : 
                    'Please enter a route first');
                return;
            }
            
            document.getElementById('requestModal').classList.add('show');
            
            // Définir la date par défaut à aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tripDate').value = today;
        }

        // Fermer le modal
        function closeRequestModal() {
            document.getElementById('requestModal').classList.remove('show');
        }

        // Fermer le modal en cliquant à l'extérieur
        window.onclick = function(event) {
            const modal = document.getElementById('requestModal');
            if (event.target == modal) {
                closeRequestModal();
            }
        }

        // Gérer la soumission du formulaire
        document.getElementById('requestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const tripDate = document.getElementById('tripDate').value;
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const flightFerry = document.getElementById('flightFerry').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            // Construire le message WhatsApp
            let message = `🚕 *DEMANDE DE COURSE DRIVY*\n\n`;
            message += `📅 Date: ${tripDate}\n`;
            message += `👤 Client: ${firstName} ${lastName}\n`;
            message += `⏰ Heure: ${document.getElementById('pickupTime').value || 'Non spécifiée'}\n`;
            if (flightFerry) {
                message += `✈️ Vol/Ferry: ${flightFerry}\n`;
            }
            message += `\n📍 *ITINÉRAIRE*\n`;
            message += `Départ: ${document.getElementById('departure').value}\n`;
            
            stops.forEach((stop, i) => {
                if (stop.address) {
                    message += `Arrêt ${i + 1}: ${stop.address}`;
                    if (stop.duration > 0) {
                        message += ` (${stop.duration} min)`;
                    }
                    message += '\n';
                }
            });
            
            message += `Destination: ${document.getElementById('destination').value}\n`;
            message += `Distance: ${totalDistanceKm.toFixed(1)} km\n`;
            
            message += `\n👥 Passagers: ${document.getElementById('passengers').value}\n`;
            
            const baggageChecked = parseInt(document.getElementById('baggageChecked').value) || 0;
            const baggageCabin = parseInt(document.getElementById('baggageCabin').value) || 0;
            const baggageBags = parseInt(document.getElementById('baggageBags').value) || 0;
            
            if (baggageChecked > 0 || baggageCabin > 0 || baggageBags > 0) {
                message += `\n🧳 *BAGAGES*\n`;
                if (baggageChecked > 0) message += `Soute: ${baggageChecked}\n`;
                if (baggageCabin > 0) message += `Cabine: ${baggageCabin}\n`;
                if (baggageBags > 0) message += `Sacs 5kg: ${baggageBags}\n`;
            }
            
            const bulkyItems = document.getElementById('bulkyItems').value;
            if (bulkyItems !== '0') {
                message += `Encombrants: ${bulkyItems === 'plus' ? '2+' : '1'}\n`;
            }
            
            if (document.getElementById('departureUpHigh').checked) {
                message += `\n⛰️ Départ en hauteur\n`;
            }
            if (document.getElementById('destinationUpHigh').checked) {
                message += `⛰️ Destination en hauteur\n`;
            }
            
            if (document.getElementById('vanBooking').checked) {
                message += `\n🚐 Réservation d'un Van\n`;
            }
            
            const fareElement = document.querySelector('.fare-display .price');
            if (fareElement) {
                message += `\n💰 *TARIF ESTIMÉ*\n`;
                message += `${fareElement.textContent}\n`;
            }
            
            const paymentMethods = {
                'cash_xpf': 'Cash en XPF',
                'cash_usd': 'Cash en USD',
                'card_eur': 'Visa/MasterCard en EUR',
                'card_usd': 'Visa/MasterCard en USD'
            };
            message += `\n💳 Paiement: ${paymentMethods[paymentMethod]}\n`;
            
            // Encoder le message pour WhatsApp
            const encodedMessage = encodeURIComponent(message);
            const whatsappNumber = '68989263268';
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
            
            // Ouvrir WhatsApp
            window.open(whatsappUrl, '_blank');
            
            // Fermer le modal
            closeRequestModal();
        });

        // Charger la clé API et initialiser Google Maps
        async function loadGoogleMapsAPI() {
            try {
                const response = await fetch('/.netlify/functions/get-maps-key');
                const data = await response.json();
                
                if (data.key) {
                    // Charger Google Maps avec le nouveau système
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${data.key}&loading=async&libraries=maps,places,routes,geocoding,marker&callback=initMap`;
                    script.async = true;
                    script.defer = true;
                    document.head.appendChild(script);
                } else {
                    console.error('Impossible de charger la clé Google Maps');
                    alert('Erreur de chargement de Google Maps');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur de connexion');
            }
        }

        // Initialiser l'application au chargement
        window.addEventListener('load', loadGoogleMapsAPI);
    </script>
</body>
</html>
